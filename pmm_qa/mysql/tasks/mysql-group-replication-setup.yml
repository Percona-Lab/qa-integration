- name: Generate my.cnf for each node
  template:
    src: my.cnf.j2
    dest: "{{ data_dir }}/node{{ item }}/my.cnf"
  loop: "{{ range(1, nodes_count | int + 1) | list }}"

- name: Create initialization script for each node
  template:
    src: init.sql.j2
    dest: "{{ data_dir }}/node{{ item }}/init.sql"
  loop: "{{ range(1, nodes_count | int + 1) | list }}"

- name: Start MySQL containers with group replication
  community.docker.docker_container:
    name: "ps_pmm_{{ ps_version }}_{{ item }}"
    image: "mysql:{{ ps_version }}"
    restart_policy: always
    state: started
    networks:
      - name: "{{ network_name }}"
    env:
      MYSQL_ROOT_PASSWORD: "{{ root_password }}"
    ports:
      - "{{ mysql_port + item - 1 }}:{{ mysql_listen_port }}"
      - "{{ group_seeds_port + item - 1 }}:{{ group_seeds_port }}"
    volumes:
      - "{{ data_dir }}/node{{ item }}/data:/var/lib/mysql"
      - "{{ data_dir }}/node{{ item }}/my.cnf:/etc/mysql/my.cnf"
      - "{{ data_dir }}/node{{ item }}/init.sql:/docker-entrypoint-initdb.d/init.sql"
  loop: "{{ range(1, nodes_count | int + 1) | list }}"

- name: Wait for MySQL to be available
  wait_for:
    host: localhost
    port: "{{ mysql_port + item - 1 }}"
    delay: 10
    timeout: 300
  loop: "{{ range(1, nodes_count | int + 1) | list }}"

- name: Reset configuration for all nodes
  community.docker.docker_container_exec:
    container: "ps_pmm_{{ ps_version }}_{{ item }}"
    command: >
      mysql -uroot -p{{ root_password }} -e "
      RESET BINARY LOGS AND GTIDS;
      RESET REPLICA ALL;
      SET GLOBAL gtid_purged='';
      "
  loop: "{{ range(1, nodes_count | int + 1) | list }}"

- name: Bootstrap first node in the cluster
  community.docker.docker_container_exec:
    container: "ps_pmm_{{ ps_version }}_1"
    command: >
      mysql -uroot -p{{ root_password }} -e "
      SET GLOBAL group_replication_bootstrap_group=ON;
      START GROUP_REPLICATION;
      SET GLOBAL group_replication_bootstrap_group=OFF;"
  retries: 5
  delay: 10

- name: Wait 5 seconds for bootstrap to complete
  pause:
    seconds: 5

- name: Start group replication on other nodes
  community.docker.docker_container_exec:
    container: "ps_pmm_{{ ps_version }}_{{ item }}"
    command: mysql -uroot -p{{ root_password }} -e "START GROUP_REPLICATION;"
  loop: "{{ range(2, nodes_count | int + 1) | list }}"
  ignore_errors: yes

- name: Wait 10 seconds for the other nodes to join
  pause:
    seconds: 10

- name: Create and seed a test database on primary
  community.docker.docker_container_exec:
    container: "ps_pmm_{{ ps_version }}_1"
    command: >
      mysql -uroot -p{{ root_password}} -e "
      CREATE DATABASE testdb;
      USE testdb;
      CREATE TABLE testdb (id INT PRIMARY KEY, data VARCHAR(100));
      INSERT INTO testdb VALUES (1, 'Initial data from node mysql1');"

- name: Check replication status on first node
  community.docker.docker_container_exec:
    container: "ps_pmm_{{ ps_version }}_1"
    command: mysql -uroot -p{{ root_password }} -e "SELECT * FROM performance_schema.replication_group_members;"
  register: replication_status

- name: Display replication status
  debug:
    var: replication_status.stdout

- name: Check replication group members count
  community.docker.docker_container_exec:
    container: "ps_pmm_{{ ps_version }}_1"
    command: mysql -uroot -p{{ root_password }} -e "SELECT COUNT(*) AS count FROM performance_schema.replication_group_members;"
  register: member_count

- name: Display member count
  debug:
    var: member_count.stdout

- name: Set verification instructions
  set_fact:
    verification_msg: |
      MySQL Cluster setup complete!

      To verify replication is working:
      1. Connect to the first node:
         docker exec -it ps_pmm_{{ ps_version }}_1 mysql -uroot -p{{ root_password }}

      2. Insert data in the test database:
         USE testdb;
         INSERT INTO testdb VALUES (100, 'Test replication');

      3. Connect to other nodes and verify data is replicated:
         docker exec -it ps_pmm_{{ ps_version }}_2 mysql -uroot -p{{ root_password }}
         USE testdb;
         SELECT * FROM testdb;

- name: Display verification instructions
  debug:
    msg: "{{ verification_msg | split('\n') }}"
