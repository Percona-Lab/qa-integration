- name: Set patroni container name variable
  set_fact:
    patroni_container_name: patroni_container

- name: Set correct nodes count for patroni setup
  set_fact:
    nodes_count: 3

- name: Fix permissions on data directory
  become: true
  file:
    path: "{{ data_dir }}/node{{ item }}/data"
    owner: 1001
    group: 1001
    recurse: yes
  loop: "{{ range(1, nodes_count | int + 1) | list }}"

- name: Generate pg_hba.conf for replica node
  template:
    src: data/postgresqlX.yml.j2
    dest: "{{ data_dir }}/node{{ item }}/postgresql{{ item }}.yml"
  loop: "{{ range(1, nodes_count | int + 1) | list }}"

- name: Create Docker network
  community.docker.docker_network:
    name: "{{ network_name }}"
    state: present
  ignore_errors: yes

- name: Start Oracle Linux 9 container
  community.docker.docker_container:
    name: "{{ patroni_container_name }}"
    image: rockylinux:9
    state: started
    restart_policy: always
    command: sleep infinity

- name: Install required packages in Oracle Linux container
  community.docker.docker_container_exec:
    container: "{{ patroni_container_name }}"
    command: >
      /bin/sh -c "
        dnf install -y epel-release &&
        dnf config-manager --set-enabled crb &&
        dnf install -y python3-click &&
        dnf install -y 'https://repo.percona.com/yum/percona-release-latest.noarch.rpm' &&
        percona-release setup ppg-17 &&
        dnf install -y python3-etcd percona-haproxy percona-patroni
      "

- name: Download postgresqlX.yml files from GitHub
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/Percona-QA/ppg-testing/main/ppg/pg-{{ pg_version }}/files/{{ item }}"
    dest: "/{{ item }}"
    mode: '0644'
  loop:
    - postgresql0.yml
    - postgresql1.yml
    - postgresql2.yml

- name: Start PostgreSQL containers
  community.docker.docker_container:
    name: "pdpgsql_pmm_{{ pg_version }}_{{ item }}"
    image: "{{ docker_repo }}:{{ pg_version }}"
    restart_policy: always
    state: started
    recreate: true
    networks:
      - name: "{{ network_name }}"
    env:
      POSTGRES_PASSWORD: "{{ root_password }}"
    volumes:
      - "{{ data_dir }}/node{{ item }}/data:/data/db"
    ports:
      - "{{ pdpgsql_port + item - 1 }}:5432"
  loop: "{{ range(1, nodes_count | int + 1) | list }}"