- name: Set patroni container name variable
  set_fact:
    patroni_container_name: patroni_container

- name: Create Docker network
  community.docker.docker_network:
    name: "{{ network_name }}"
    state: present
  ignore_errors: yes

- name: Start Oracle Linux 9 container
  community.docker.docker_container:
    name: "{{ patroni_container_name }}"
    image: rockylinux:9
    state: started
    restart_policy: always
    command: sleep infinity

- name: Install required packages in Oracle Linux container
  community.docker.docker_container_exec:
    container: "{{ patroni_container_name }}"
    command: >
      /bin/sh -c "
        dnf install -y epel-release &&
        dnf config-manager --set-enabled crb &&
        dnf install -y python3-click &&
        dnf install -y 'https://repo.percona.com/yum/percona-release-latest.noarch.rpm' &&
        percona-release setup ppg-17 &&
        dnf install -y python3-etcd percona-haproxy percona-patroni
      "

- name: Download postgresqlX.yml files from GitHub
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/Percona-QA/ppg-testing/main/ppg/pg-{{ pg_version }}/files/{{ item }}"
    dest: "/{{ item }}"
    mode: '0644'
  loop:
    - postgresql0.yml
    - postgresql1.yml
    - postgresql2.yml
