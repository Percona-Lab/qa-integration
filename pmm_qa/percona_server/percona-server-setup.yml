---
# Percona Server 8.4 and higher single instance and also Cluster with Group Replication
- name: Setup Percona Server 8.4 and higher. Cluster with Group Replication in Docker
  hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    ps_version: "{{ lookup('env', 'PS_VERSION') | default('8.4', true) }}"
    cluster_name: "mysql_cluster"
    replication_user: "repl_user"
    replication_password: "GRgrO9301RuF"
    root_password: "GRgrO9301RuF"
    mysql_port: 33066
    mysql_listen_port: 3306
    group_seeds_port: 34061
    nodes_count: "{{ (lookup('env', 'NODES_COUNT') | default('3', true)) | int }}"
    network_name: "pmm-qa"
    data_dir: "{{ lookup('env', 'HOME') }}/mysql_cluster_data"
    server_id_start: 1
    pmm_server_ip: "{{ lookup('vars', 'extra_pmm_server_ip', default=lookup('env','PMM_SERVER_IP') | default('127.0.0.1', true) ) }}"
    client_version: "{{ lookup('vars', 'extra_client_version', default=lookup('env','CLIENT_VERSION') | default('3-dev-latest', true) ) }}"
    admin_password: "{{ lookup('vars', 'extra_admin_password', default=lookup('env','ADMIN_PASSWORD') | default('admin', true) ) }}"
    query_source: "{{ lookup('env', 'QUERY_SOURCE') | default('perfschema', true) }}"
    setup_type: "{{ lookup('env', 'SETUP_TYPE') }}"

  tasks:
    - name: Create Docker network
      community.docker.docker_network:
        name: "{{ network_name }}"
        state: present

    - name: "Remove old data folders"
      shell: 'rm -fr {{ data_dir }}'
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Create data directories
      file:
        path: "{{ data_dir }}/node{{ item }}/data"
        state: directory
        mode: '0755'
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Generate my.cnf for each node
      template:
        src: my.cnf.j2
        dest: "{{ data_dir }}/node{{ item }}/my.cnf"
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: setup_type == "gr"

    - name: Create initialization script for each node
      template:
        src: init.sql.j2
        dest: "{{ data_dir }}/node{{ item }}/init.sql"
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: setup_type == "gr"

    - name: Generate master.cnf.j2 for replication
      template:
        src: replication/master.cnf.j2
        dest: "{{ data_dir }}/node1/master.cnf.j2"
      when: setup_type == "replication"

    - name: Create slave.cnf for replication
      template:
        src: replication/slave.cnf.j2
        dest: "{{ data_dir }}/node{{ item }}/slave.cnf"
      loop: "{{ range(2, nodes_count | int + 1) | list }}"
      when: setup_type == "replication"

    - name: Remove old percona server containers
      community.docker.docker_container:
        name: "ps_pmm_{{ ps_version }}_{{ item }}"
        image: "percona/percona-server:{{ ps_version }}"
        restart_policy: always
        state: absent
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      ignore_errors: yes

    - name: Remove old percona server containers
      community.docker.docker_container:
        name: "ps_pmm_gr_{{ ps_version }}_{{ item }}"
        image: "percona/percona-server:{{ ps_version }}"
        restart_policy: always
        state: absent
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      ignore_errors: yes
      when: setup_type == "gr"

    - name: Remove old percona server containers
      community.docker.docker_container:
        name: "ps_pmm_replication_{{ ps_version }}_{{ item }}"
        image: "percona/percona-server:{{ ps_version }}"
        restart_policy: always
        state: absent
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      ignore_errors: yes
      when: setup_type == "replication"

    - name: Recursively change ownership of a directory
      shell: "sudo chown -R 1001:1001 {{ data_dir }}/node{{ item }}/data"
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Start Percona Server containers with group replication
      community.docker.docker_container:
        name: "ps_pmm_gr_{{ ps_version }}_{{ item }}"
        image: "percona/percona-server:{{ ps_version }}"
        restart_policy: always
        state: started
        networks:
          - name: "{{ network_name }}"
        env:
          MYSQL_ROOT_PASSWORD: "{{ root_password }}"
        ports:
          - "{{ mysql_port + item - 1 }}:{{ mysql_listen_port }}"
          - "{{ group_seeds_port + item - 1 }}:{{ group_seeds_port }}"
        volumes:
          - "{{ data_dir }}/node{{ item }}/data:/var/lib/mysql"
          - "{{ data_dir }}/node{{ item }}/my.cnf:/etc/mysql/my.cnf"
          - "{{ data_dir }}/node{{ item }}/init.sql:/docker-entrypoint-initdb.d/init.sql"
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: setup_type == "gr"

    - name: Start Percona Server master container with replication
      community.docker.docker_container:
        name: "ps_pmm_replication_{{ ps_version }}_1"
        image: "percona/percona-server:{{ ps_version }}"
        restart_policy: always
        state: started
        networks:
          - name: "{{ network_name }}"
        env:
          MYSQL_ROOT_PASSWORD: "{{ root_password }}"
        ports:
          - "{{ mysql_port }}:{{ mysql_listen_port }}"
          - "{{ group_seeds_port }}:{{ group_seeds_port }}"
        volumes:
          - "{{ data_dir }}/node1/data:/var/lib/mysql"
          - "{{ data_dir }}/node1/master.cnf:/etc/mysql/conf.d/master.cnf"
          - "{{ data_dir }}/node1/init.sql:/docker-entrypoint-initdb.d/init.sql"
      when: setup_type == "replication"

    - name: Start Percona Server slave containers with replication
      community.docker.docker_container:
        name: "ps_pmm_replication_{{ ps_version }}_{{ item }}"
        image: "percona/percona-server:{{ ps_version }}"
        restart_policy: always
        state: started
        networks:
          - name: "{{ network_name }}"
        env:
          MYSQL_ROOT_PASSWORD: "{{ root_password }}"
        ports:
          - "{{ mysql_port + item - 1 }}:{{ mysql_listen_port }}"
          - "{{ group_seeds_port + item - 1 }}:{{ group_seeds_port }}"
        volumes:
          - "{{ data_dir }}/node{{ item }}/data:/var/lib/mysql"
          - "{{ data_dir }}/node{{ item }}/slave.cnf:/etc/mysql/conf.d/slave.cnf"
          - "{{ data_dir }}/node{{ item }}/init.sql:/docker-entrypoint-initdb.d/init.sql"
      loop: "{{ range(2, nodes_count | int + 1) | list }}"
      when: setup_type == "replication"

    - name: Start Percona Server containers
      community.docker.docker_container:
        name: "ps_pmm_{{ ps_version }}_{{ item }}"
        image: "percona/percona-server:{{ ps_version }}"
        restart_policy: always
        state: started
        networks:
          - name: "{{ network_name }}"
        env:
          MYSQL_ROOT_PASSWORD: "{{ root_password }}"
        ports:
          - "{{ mysql_port + item - 1 }}:{{ mysql_listen_port }}"
          - "{{ group_seeds_port + item - 1 }}:{{ group_seeds_port }}"
        volumes:
          - "{{ data_dir }}/node{{ item }}/data:/var/lib/mysql"
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: setup_type != "gr" and setup_type != "replication"

    - name: Wait for MySQL to be available
      wait_for:
        host: localhost
        port: "{{ mysql_port + item - 1 }}"
        delay: 10
        timeout: 300
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Reset configuration for all nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          RESET BINARY LOGS AND GTIDS;
          RESET REPLICA ALL;
          SET GLOBAL gtid_purged='';
          "
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      ignore_errors: yes
      when: setup_type == "gr"

    - name: Create slowlog configuration for mysql nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          SET GLOBAL slow_query_log='ON';
          SET GLOBAL long_query_time=0;
          SET GLOBAL log_slow_admin_statements=ON;
          SET GLOBAL log_slow_slave_statements=ON;
          "
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: query_source == "slowlog"

    - name: Bootstrap first node in the cluster
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_1"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          SET GLOBAL group_replication_bootstrap_group=ON;
          START GROUP_REPLICATION;
          SET GLOBAL group_replication_bootstrap_group=OFF;"
      when: setup_type == "gr"
      retries: 5
      delay: 10

    - name: Bootstrap first node in the replication cluster
      community.docker.docker_container_exec:
        container: "ps_pmm_replication_{{ ps_version }}_1"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          CREATE USER 'repl'@'localhost' IDENTIFIED BY 'replpass';
          GRANT REPLICATION SLAVE ON *.* TO 'repl'@'localhost';
          CREATE USER 'repl'@'127.0.0.1' IDENTIFIED BY 'replpass';
          GRANT REPLICATION SLAVE ON *.* TO 'repl'@'127.0.0.1';
          FLUSH PRIVILEGES;

          FLUSH TABLES WITH READ LOCK;
          SHOW MASTER STATUS;
          "
      when: setup_type == "replication"
      retries: 5
      delay: 10

    - name: Wait 5 seconds for bootstrap to complete
      pause:
        seconds: 5
      when: setup_type == "gr"

    - name: Start group replication on other nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: mysql -uroot -p{{ root_password }} -e "START GROUP_REPLICATION;"
      loop: "{{ range(2, nodes_count | int + 1) | list }}"
      ignore_errors: yes
      when: setup_type == "gr"

    - name: Start replication on other nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_replication_{{ ps_version }}_{{ item }}"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          CHANGE MASTER TO
          MASTER_HOST='ps_pmm_replication_{{ ps_version }}_1',
          MASTER_USER='repl',
          MASTER_PASSWORD='replpass',
          MASTER_LOG_FILE='mysql-bin.000001',
          MASTER_LOG_POS=154;

          START SLAVE;
          SHOW SLAVE STATUS\G"
      loop: "{{ range(2, nodes_count | int + 1) | list }}"
      ignore_errors: yes
      when: setup_type == "replication"

    - name: Wait 10 seconds for the other nodes to join
      pause:
        seconds: 10
      when: setup_type == "gr"

    - name: Create and seed a test database on primary
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_1"
        command: >
          mysql -uroot -p{{ root_password}} -e "
          CREATE DATABASE testdb;
          USE testdb;
          CREATE TABLE testdb (id INT PRIMARY KEY, data VARCHAR(100));
          INSERT INTO testdb VALUES (1, 'Initial data from node mysql1');"
      when: setup_type == "gr"

    - name: Check replication status on first node
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_1"
        command: mysql -uroot -p{{ root_password }} -e "SELECT * FROM performance_schema.replication_group_members;"
      register: replication_status
      when: setup_type == "gr"

    - name: Display replication status
      debug:
        var: replication_status.stdout
      when: setup_type == "gr"

    - name: Check replication group members count
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_1"
        command: mysql -uroot -p{{ root_password }} -e "SELECT COUNT(*) AS count FROM performance_schema.replication_group_members;"
      register: member_count
      when: setup_type == "gr"

    - name: Display member count
      debug:
        var: member_count.stdout
      when: setup_type == "gr"

    - name: Set verification instructions
      set_fact:
        verification_msg: |
          MySQL Cluster setup complete!

          To verify replication is working:
          1. Connect to the first node:
             docker exec -it ps_pmm_{{ ps_version }}_1 mysql -uroot -p{{ root_password }}

          2. Insert data in the test database:
             USE testdb;
             INSERT INTO testdb VALUES (100, 'Test replication');

          3. Connect to other nodes and verify data is replicated:
             docker exec -it ps_pmm_{{ ps_version }}_2 mysql -uroot -p{{ root_password }}
             USE testdb;
             SELECT * FROM testdb;
      when: setup_type == "gr"

    - name: Display verification instructions
      debug:
        msg: "{{ verification_msg | split('\n') }}"
      when: setup_type == "gr"

    - name: Install and add pmm client.
      include_tasks: ../tasks/install_pmm_client_centos.yml
      vars:
        container_name: "ps_pmm_{{ ps_version }}_{{ item }}"
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Add service to pmm server
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: pmm-admin add mysql --query-source={{ query_source }} --username=root --password={{ root_password }} --environment=ps-gr-dev --cluster=ps-gr-dev-cluster --replication-set=ps-gr-replication ps_pmm_{{ ps_version }}_{{ item }} --debug 127.0.0.1:3306
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: setup_type == "gr"

    - name: Add service to pmm server
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: pmm-admin add mysql --query-source={{ query_source }} --username=root --password={{ root_password }} --environment=ps-dev ps_pmm_{{ ps_version }}_{{ item }} --debug 127.0.0.1:3306
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: setup_type != "gr"

    - name: Install sysbench inside of all percona server nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        user: "root"
        command: >
          /bin/sh -c "
          wget -O epel-release.rpm --progress=dot:giga https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm &&
          rpm -i epel-release.rpm &&
          microdnf install -y sysbench
          "
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Prepare sysbench inside of all percona server nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          SET GLOBAL super_read_only = OFF;
          SET GLOBAL read_only = OFF;
          "
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Prepare sysbench inside of all percona server nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          CREATE DATABASE sbtest;
          CREATE USER 'sbtest'@'localhost' IDENTIFIED BY 'password';
          GRANT ALL PRIVILEGES ON *.* TO 'sbtest'@'localhost';
          CREATE USER 'sbtest'@'127.0.0.1' IDENTIFIED BY 'password';
          GRANT ALL PRIVILEGES ON *.* TO 'sbtest'@'127.0.0.1';
          FLUSH PRIVILEGES;
          "
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
      when: setup_type != "gr"

    - name: Prepare sysbench inside of all percona server nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_1"
        command: >
          mysql -uroot -p{{ root_password }} -e "
          CREATE DATABASE sbtest;
          CREATE USER 'sbtest'@'localhost' IDENTIFIED BY 'password';
          GRANT ALL PRIVILEGES ON *.* TO 'sbtest'@'localhost';
          CREATE USER 'sbtest'@'127.0.0.1' IDENTIFIED BY 'password';
          GRANT ALL PRIVILEGES ON *.* TO 'sbtest'@'127.0.0.1';
          FLUSH PRIVILEGES;
          "
      when: setup_type == "gr"

    - name: Prepare data for sysbench inside of all percona server nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: >
          sysbench /usr/share/sysbench/oltp_read_write.lua 
            --mysql-host=127.0.0.1 
            --mysql-port=3306 
            --mysql-user=sbtest 
            --mysql-password=password 
            --mysql-db=sbtest 
            --tables=10 
            --table-size=100000 
            prepare
      when: setup_type != "gr"
      loop: "{{ range(1, nodes_count | int + 1) | list }}"

    - name: Prepare data for sysbench inside of first percona server nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_1"
        command: >
          sysbench /usr/share/sysbench/oltp_read_write.lua 
            --mysql-host=127.0.0.1 
            --mysql-port=3306 
            --mysql-user=sbtest 
            --mysql-password=password 
            --mysql-db=sbtest 
            --tables=10 
            --table-size=100000 
            prepare
      when: setup_type == "gr"

    - name: Run load for sysbench inside of all percona server nodes
      community.docker.docker_container_exec:
        container: "ps_pmm_{{ ps_version }}_{{ item }}"
        command: >
          sysbench /usr/share/sysbench/oltp_read_write.lua 
            --mysql-host=127.0.0.1 
            --mysql-port=3306 
            --mysql-user=sbtest 
            --mysql-password=password 
            --mysql-db=sbtest 
            --tables=10 
            --table-size=100000 
            --threads=16 
            --time=60 
            run
      loop: "{{ range(1, nodes_count | int + 1) | list }}"
