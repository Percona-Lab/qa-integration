- name: Find first free port starting at {{ port_start }}
  vars:
    port_range_end: "{{ port_start | int + 100 }}"
  block:
    - name: Probe ports until first free one is found
      ansible.builtin.include_tasks: probe_one_port.yml
      loop: "{{ range(port_start | int, port_range_end | int) | list }}"
      loop_control:
        label: "Checking port {{ item }}"
      vars:
        candidate_port: "{{ item }}"

    - name: Verify a port was found
      ansible.builtin.fail:
        msg: "No free port found in range {{ port_start }} to {{ port_range_end - 1 }}"
      when: docker_port is none

    - name: Display result
      ansible.builtin.debug:
        msg: "First free port found: {{ docker_port }}"