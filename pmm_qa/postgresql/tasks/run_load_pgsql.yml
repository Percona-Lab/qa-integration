# This ansible file run load on docker container of pgsql with variable name node_name

- name: Detect OS inside the container
  community.docker.docker_container_exec:
    container: "{{ node_name }}"
    command: cat /etc/os-release
  register: container_os_info

- name: Set distro family (debian/rhel)
  set_fact:
    distro_family: >-
      {{
        (
          'debian' if 'debian' in container_os_info.stdout | lower else
          'rhel' if 'rhel' in container_os_info.stdout | lower or 'centos' in container_os_info.stdout | lower or 'fedora' in container_os_info.stdout | lower
          else 'unknown'
        ) | trim
      }}

- name: Create custom database for pgbench
  community.docker.docker_container_exec:
    container: "{{ node_name }}"
    user: postgres
    command: >
      psql -U postgres -c "
        CREATE DATABASE pgbench;
        GRANT CONNECT ON DATABASE pgbench TO pmm;
        GRANT USAGE ON SCHEMA public TO pmm;
        GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO pmm;
        ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO pmm;"
      "

- name: Ensure pgbench is installed (Debian-based container)
  community.docker.docker_container_exec:
    container: "{{ node_name }}"
    user: root
    command: >
      /bin/sh -c "
      apt-get update &&
      apt-get install -y postgresql-contrib
      "
  when: distro_family == "debian"

- name: Ensure pgbench is installed (RHEL-based container)
  community.docker.docker_container_exec:
    container: "{{ node_name }}"
    user: root
    command: microdnf install -y postgresql-contrib
  when: distro_family == "rhel"

- name: Initialize pgbench database
  community.docker.docker_container_exec:
    container: "{{ node_name }}"
    user: postgres
    command: >
      pgbench -i -s {{ pgbench_scale }} pgbench

- name: Copy populate script into container
  community.docker.docker_container_copy_into:
    container: "{{ node_name }}"
    path: ./data/sample_data.sql
    container_path: /sample_data.sql

- name: Populate pgbench tables with sample data
  community.docker.docker_container_exec:
    container: "{{ node_name }}"
    user: postgres
    command: >
      psql -U postgres -d pgbench -f /sample_data.sql

- name: Copy realistic workload SQL into container
  community.docker.docker_container_copy_into:
    container: "{{ node_name }}"
    path: ./data/workload.sql
    container_path: /workload.sql

- name: Run pgbench benchmark
  community.docker.docker_container_exec:
    container: "{{ node_name }}"
    user: postgres
    command: >
      pgbench -c {{ pgbench_clients }} -T {{ pgbench_time }} -f /workload.sql pgbench
  register: pgbench_result

- name: Print pgbench results
  debug:
    var: pgbench_result.stdout_lines